Oui — **implémente maintenant**, dans cet ordre précis. Pas besoin de me redemander “tu veux ?” : c’est exactement ce qu’il faut faire pour passer en prod propre.

Je te donne **quoi changer, où, et le code exact** (minimal, sans refactor inutile).

---

# 1) Express : `trust proxy` + CORS restreint (prod)

## Où ?

Dans **`/var/www/menu-cafet/server/index.js`** (ou le fichier équivalent côté repo).

## Quoi faire exactement ?

### A) Active `trust proxy` (juste après la création de `app`)

Ajoute :

```js
app.set('trust proxy', 1);
```

> Pourquoi : derrière Nginx, Express doit faire confiance à `X-Forwarded-*` (IP, protocole HTTPS). Sinon tu auras des comportements bizarres en prod (IP client, secure cookies, redirections).
> Référence Express : “trust proxy”. (Documentation officielle Express)

### B) CORS restreint en prod

Actuellement tu as `app.use(cors());` → trop permissif.

Remplace par :

```js
const allowedOrigins = (process.env.CORS_ORIGINS || '')
  .split(',')
  .map(s => s.trim())
  .filter(Boolean);

app.use(cors({
  origin: (origin, cb) => {
    // Autorise curl / serveur-to-serveur (origin undefined)
    if (!origin) return cb(null, true);

    // En dev: autoriser tout (si tu veux)
    if (process.env.NODE_ENV !== 'production') return cb(null, true);

    // En prod: autoriser uniquement la whitelist
    if (allowedOrigins.includes(origin)) return cb(null, true);

    return cb(new Error('Not allowed by CORS'), false);
  },
  credentials: true,
}));
```

### C) Variables `.env` à ajouter (prod)

Dans **`/var/www/menu-cafet/.env`** :

```env
NODE_ENV=production
CORS_ORIGINS=https://cafeteria.applications.ws
```

*(Tu peux ajouter aussi l’URL HTTP si tu l’utilises encore, mais idéalement tu forces HTTPS.)*

---

# 2) PM2 : `ecosystem.config.js` (fiabiliser + logs)

## Où ?

À la racine du projet : **`/var/www/menu-cafet/ecosystem.config.cjs`**

*(Je mets `.cjs` pour éviter les soucis ESM/require.)*

## Contenu exact :

```js
module.exports = {
  apps: [
    {
      name: "menu-cafet",
      script: "server/index.js",
      instances: 1,
      exec_mode: "fork",
      autorestart: true,
      max_memory_restart: "300M",
      env: {
        NODE_ENV: "production"
      },
      out_file: "/var/log/menu-cafet/out.log",
      error_file: "/var/log/menu-cafet/error.log",
      merge_logs: true,
      time: true
    }
  ]
};
```

## Préparer le dossier logs

```bash
sudo mkdir -p /var/log/menu-cafet
sudo chown -R root:root /var/log/menu-cafet
sudo chmod 755 /var/log/menu-cafet
```

## Redémarrer via ecosystem

```bash
cd /var/www/menu-cafet
pm2 delete menu-cafet || true
pm2 start ecosystem.config.cjs
pm2 save
pm2 status
```

---

# 3) Endpoint `/api/health` (monitoring simple)

## Où ?

Dans ton router `menuRoutes` (vu que tu montes `app.use('/api', menuRoutes);`), donc :

**`/var/www/menu-cafet/server/routes/menu.js`**

## Quoi ajouter (tout en haut, après `const router = ...`) :

```js
router.get('/health', async (req, res) => {
  try {
    await db.query('SELECT 1');
    return res.status(200).json({ ok: true, db: 'up' });
  } catch (e) {
    return res.status(200).json({ ok: true, db: 'down' });
  }
});
```

> On renvoie 200 même si DB down : ça permet de savoir si **le service répond** (et tu lis `db: down`).
> Si tu préfères “db down = 503”, dis-le, mais pour ton cas ORIF, 200 + état est très pédagogique.

## Test

```bash
curl -i http://localhost/api/health
```

---

# 4) Après modifications : redémarrage + tests

### Redémarre

```bash
pm2 restart menu-cafet --update-env
pm2 logs menu-cafet --lines 30
```

### Tests

```bash
curl -I http://localhost/
curl -I http://localhost/api/
curl -i http://localhost/api/health
```

---

# 5) Ensuite : HTTPS (Certbot)

Une fois que tout ça passe, tu peux lancer :

```bash
sudo apt install -y certbot python3-certbot-nginx
sudo certbot --nginx -d cafeteria.applications.ws
```

---

## Ce que je veux que tu me colles après implémentation

1. les 10 premières lignes de `server/index.js` (pour confirmer CORS + trust proxy)
2. le contenu de `ecosystem.config.cjs`
3. sortie de :

```bash
curl -i http://localhost/api/health
pm2 status
```

Et on sera officiellement “prod-ready”.
